<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="ExDoc v0.28.4">
    <meta name="project" content="riax v0.1.0">

    <title>Riax.VNode â€” riax v0.1.0</title>
    <link rel="stylesheet" href="dist/elixir-b6f1ed5df9b1d42a7309.css" />

    <script src="dist/sidebar_items-160dab9d99.js"></script>

      <script src="docs_config.js"></script>

    <script async src="dist/app-bd1cb213813bf4825aa2.js"></script>


  </head>
  <body data-type="modules">
    <script>

      try {
        var settings = JSON.parse(localStorage.getItem('ex_doc:settings') || '{}');

        if (settings.theme === 'dark' ||
           ((settings.theme === 'system' || settings.theme == null) &&
             window.matchMedia('(prefers-color-scheme: dark)').matches)
           ) {
          document.body.classList.add('dark')
        }
      } catch (error) { }
    </script>

<div class="main">


<section class="sidebar">
  <button class="sidebar-button sidebar-toggle" aria-label="toggle sidebar">
    <i class="ri-menu-line ri-lg" title="Collapse/expand sidebar"></i>
  </button>

  <form class="sidebar-search" action="search.html">
    <button type="submit" class="search-button" aria-label="Submit Search">
      <i class="ri-search-2-line" aria-hidden="true" title="Submit search"></i>
    </button>
    <button type="button" tabindex="-1" class="search-close-button" aria-label="Cancel Search">
      <i class="ri-close-line ri-lg" aria-hidden="true" title="Cancel search"></i>
    </button>
    <label class="search-label">
      <p class="sr-only">Search</p>
      <input name="q" type="text" class="search-input" placeholder="Search..." aria-label="Input your search terms" autocomplete="off" />
    </label>
  </form>

  <div class="autocomplete">
    <div class="autocomplete-results">
    </div>
  </div>

  <div class="sidebar-header">

    <div class="sidebar-projectDetails">
      <a href="api-reference.html" class="sidebar-projectName" translate="no">
riax
      </a>
      <strong class="sidebar-projectVersion" translate="no">
        v0.1.0
      </strong>
    </div>
    <ul class="sidebar-listNav">
      <li><a id="extras-list-link" href="#full-list">Pages</a></li>

        <li><a id="modules-list-link" href="#full-list">Modules</a></li>


    </ul>
  </div>

  <div class="gradient"></div>
  <ul id="full-list" class="sidebar-fullList"></ul>
</section>

<section class="content">
  <output role="status" id="toast"></output>
  <div class="content-outer">
    <div id="content" class="content-inner">

<h1>
<button class="settings display-settings">
  <i class="ri-settings-3-line"></i>
  <span class="sr-only">Settings</span>
</button>


  <span translate="no">Riax.VNode</span> <small>behaviour</small>
  <small class="app-vsn" translate="no">(riax v0.1.0)</small>

</h1>


  <section id="moduledoc">
<p>A virtual node is an Elixir (or Erlang) process responsible for a partition of
keys from <a href="https://raw.githubusercontent.com/lambdaclass/riak_core_tutorial/master/ring.png">the ring</a>.
The key word here is virtual (as opposed to physical), because we can have
many virtual nodes running on a physical node. In the picture, the colored
squares are physical nodes. With consistent hashing, we can determine which
node should handle a given key, depending on which partition (and therefore,
VNode) the key ends up. The way that keys are distributed is the Handoff,
which is explained on a section below. The virtual node is responsible for
handling requests and can store data to be retrieved. It is important to bear
in mind that VNodes are not bound to a particular to a particular physical
node. They can be relocated to another physical nodes as new nodes are added
(using Riax.join) or a certain physical node is not available. Adding new
nodes easily is useful for horizontal scaling.</p><p>To implement this Virtual Node, we provide an easy to use behaviour. Here's an
example of using a Virtual Node as a Key-Value store.</p><h1>Example</h1><pre><code class="makeup elixir" translate="no"><span class="kd">defmodule</span><span class="w"> </span><span class="nc">Riax.VNode.Impl</span><span class="w"> </span><span class="k" data-group-id="7893346178-1">do</span><span class="w">
  </span><span class="kn">require</span><span class="w"> </span><span class="nc">Logger</span><span class="w">
  </span><span class="na">@behaviour</span><span class="w"> </span><span class="nc">Riax.VNode</span><span class="w">
  </span><span class="kd">def</span><span class="w"> </span><span class="nf">init</span><span class="p" data-group-id="7893346178-2">(</span><span class="p" data-group-id="7893346178-3">[</span><span class="n">partition</span><span class="p" data-group-id="7893346178-3">]</span><span class="p" data-group-id="7893346178-2">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-4">do</span><span class="w">
      </span><span class="p" data-group-id="7893346178-5">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-6">%{</span><span class="ss">partition</span><span class="p">:</span><span class="w"> </span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7893346178-7">%{</span><span class="p" data-group-id="7893346178-7">}</span><span class="p" data-group-id="7893346178-6">}</span><span class="p" data-group-id="7893346178-5">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-4">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_command</span><span class="p" data-group-id="7893346178-8">(</span><span class="p" data-group-id="7893346178-9">{</span><span class="ss">:ping</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-9">}</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-10">%{</span><span class="ss">partition</span><span class="p">:</span><span class="w"> </span><span class="n">partition</span><span class="p" data-group-id="7893346178-10">}</span><span class="p" data-group-id="7893346178-8">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-11">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-12">(</span><span class="s">&quot;Received ping command!&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-12">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-13">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-14">{</span><span class="ss">:pong</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">node</span><span class="p" data-group-id="7893346178-15">(</span><span class="p" data-group-id="7893346178-15">)</span><span class="p">,</span><span class="w"> </span><span class="n">partition</span><span class="p" data-group-id="7893346178-14">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-13">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-11">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_command</span><span class="p" data-group-id="7893346178-16">(</span><span class="p" data-group-id="7893346178-17">{</span><span class="ss">:put</span><span class="p">,</span><span class="w"> </span><span class="ss">:no_log</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-18">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-18">}</span><span class="p" data-group-id="7893346178-17">}</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-19">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="7893346178-19">}</span><span class="p" data-group-id="7893346178-16">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-20">do</span><span class="w">
      </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="7893346178-21">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-21">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-22">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-23">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">new_data</span><span class="p" data-group-id="7893346178-23">}</span><span class="p" data-group-id="7893346178-22">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-20">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_command</span><span class="p" data-group-id="7893346178-24">(</span><span class="p" data-group-id="7893346178-25">{</span><span class="ss">:put</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-26">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-26">}</span><span class="p" data-group-id="7893346178-25">}</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-27">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="7893346178-27">}</span><span class="p" data-group-id="7893346178-24">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-28">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-29">(</span><span class="s">&quot;PUT Key: </span><span class="si" data-group-id="7893346178-30">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-31">(</span><span class="n">k</span><span class="p" data-group-id="7893346178-31">)</span><span class="si" data-group-id="7893346178-30">}</span><span class="s">, Value: </span><span class="si" data-group-id="7893346178-32">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-33">(</span><span class="n">v</span><span class="p" data-group-id="7893346178-33">)</span><span class="si" data-group-id="7893346178-32">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-29">)</span><span class="w">
      </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="7893346178-34">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-34">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-35">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-36">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">new_data</span><span class="p" data-group-id="7893346178-36">}</span><span class="p" data-group-id="7893346178-35">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-28">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_command</span><span class="p" data-group-id="7893346178-37">(</span><span class="p" data-group-id="7893346178-38">{</span><span class="ss">:get</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="7893346178-38">}</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-39">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="7893346178-39">}</span><span class="p" data-group-id="7893346178-37">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-40">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-41">(</span><span class="s">&quot;GET </span><span class="si" data-group-id="7893346178-42">#{</span><span class="n">key</span><span class="si" data-group-id="7893346178-42">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-41">)</span><span class="w">

      </span><span class="n">reply</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="k">case</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="7893346178-43">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="7893346178-43">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-44">do</span><span class="w">
          </span><span class="no">nil</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="ss">:not_found</span><span class="w">
          </span><span class="n">value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="w">
      </span><span class="k" data-group-id="7893346178-44">end</span><span class="w">

      </span><span class="p" data-group-id="7893346178-45">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="n">reply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-45">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-40">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_command</span><span class="p" data-group-id="7893346178-46">(</span><span class="p" data-group-id="7893346178-47">{</span><span class="ss">:delete</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="7893346178-47">}</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-48">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="7893346178-48">}</span><span class="p" data-group-id="7893346178-46">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-49">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-50">(</span><span class="s">&quot;DELETE </span><span class="si" data-group-id="7893346178-51">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-52">(</span><span class="n">key</span><span class="p" data-group-id="7893346178-52">)</span><span class="si" data-group-id="7893346178-51">}</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-50">)</span><span class="w">
      </span><span class="n">new_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">delete</span><span class="p" data-group-id="7893346178-53">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p" data-group-id="7893346178-53">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-54">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">get</span><span class="p" data-group-id="7893346178-55">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="ss">:not_found</span><span class="p" data-group-id="7893346178-55">)</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-56">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">new_data</span><span class="p" data-group-id="7893346178-56">}</span><span class="p" data-group-id="7893346178-54">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-49">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_command</span><span class="p" data-group-id="7893346178-57">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-57">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-58">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-59">(</span><span class="s">&quot;unhandle command </span><span class="si" data-group-id="7893346178-60">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-61">(</span><span class="n">message</span><span class="p" data-group-id="7893346178-61">)</span><span class="si" data-group-id="7893346178-60">}</span><span class="s">&quot;</span><span class="p" data-group-id="7893346178-59">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-62">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-62">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-58">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handoff_starting</span><span class="p" data-group-id="7893346178-63">(</span><span class="n">target_node</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-64">%{</span><span class="ss">partition</span><span class="p">:</span><span class="w"> </span><span class="c">_partition</span><span class="p" data-group-id="7893346178-64">}</span><span class="p" data-group-id="7893346178-63">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-65">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-66">(</span><span class="w">
      </span><span class="s">&quot;Handoff starting with target: </span><span class="si" data-group-id="7893346178-67">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-68">(</span><span class="n">target_node</span><span class="p" data-group-id="7893346178-68">)</span><span class="si" data-group-id="7893346178-67">}</span><span class="s"> - State: </span><span class="si" data-group-id="7893346178-69">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-70">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-70">)</span><span class="si" data-group-id="7893346178-69">}</span><span class="s">&quot;</span><span class="w">
      </span><span class="p" data-group-id="7893346178-66">)</span><span class="w">

      </span><span class="p" data-group-id="7893346178-71">{</span><span class="no">true</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-71">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-65">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handoff_finished</span><span class="p" data-group-id="7893346178-72">(</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-73">%{</span><span class="ss">partition</span><span class="p">:</span><span class="w"> </span><span class="n">partition</span><span class="p" data-group-id="7893346178-73">}</span><span class="p" data-group-id="7893346178-72">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-74">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-75">(</span><span class="w">
      </span><span class="s">&quot;Handoff finished with target: </span><span class="si" data-group-id="7893346178-76">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-77">(</span><span class="n">dest</span><span class="p" data-group-id="7893346178-77">)</span><span class="si" data-group-id="7893346178-76">}</span><span class="s">, partition: </span><span class="si" data-group-id="7893346178-78">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-79">(</span><span class="n">partition</span><span class="p" data-group-id="7893346178-79">)</span><span class="si" data-group-id="7893346178-78">}</span><span class="s">&quot;</span><span class="w">
      </span><span class="p" data-group-id="7893346178-75">)</span><span class="w">

      </span><span class="p" data-group-id="7893346178-80">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-80">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-74">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_handoff_fold</span><span class="p" data-group-id="7893346178-81">(</span><span class="n">fold_function</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="c">_sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-81">)</span><span class="w">
      </span><span class="ow">when</span><span class="w"> </span><span class="n">is_function</span><span class="p" data-group-id="7893346178-82">(</span><span class="n">fold_function</span><span class="p" data-group-id="7893346178-82">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-83">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-84">(</span><span class="s">&quot;&gt;&gt;&gt;&gt;&gt; Handoff V2 &lt;&lt;&lt;&lt;&lt;&lt;&quot;</span><span class="p" data-group-id="7893346178-84">)</span><span class="w">

      </span><span class="n">acc</span><span class="w"> </span><span class="o">=</span><span class="w">
      </span><span class="n">state</span><span class="o">.</span><span class="n">data</span><span class="w">
      </span><span class="o">|&gt;</span><span class="w"> </span><span class="nc">Enum</span><span class="o">.</span><span class="n">reduce</span><span class="p" data-group-id="7893346178-85">(</span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="7893346178-86">fn</span><span class="w"> </span><span class="p" data-group-id="7893346178-87">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-87">}</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
          </span><span class="n">fold_function</span><span class="o">.</span><span class="p" data-group-id="7893346178-88">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p" data-group-id="7893346178-88">)</span><span class="w">
      </span><span class="k" data-group-id="7893346178-86">end</span><span class="p" data-group-id="7893346178-85">)</span><span class="w">

      </span><span class="p" data-group-id="7893346178-89">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="n">acc</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-89">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-83">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_handoff_command</span><span class="p" data-group-id="7893346178-90">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-90">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-91">do</span><span class="w">
      </span><span class="n">handle_command</span><span class="p" data-group-id="7893346178-92">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-92">)</span><span class="w">
  </span><span class="k" data-group-id="7893346178-91">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">is_empty</span><span class="p" data-group-id="7893346178-93">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-93">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-94">do</span><span class="w">
      </span><span class="n">is_empty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_size</span><span class="p" data-group-id="7893346178-95">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-95">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w">
      </span><span class="p" data-group-id="7893346178-96">{</span><span class="n">is_empty</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-96">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-94">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">delete</span><span class="p" data-group-id="7893346178-97">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-97">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-98">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-99">(</span><span class="s">&quot;Deleting the vnode data&quot;</span><span class="p" data-group-id="7893346178-99">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-100">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-101">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7893346178-102">%{</span><span class="p" data-group-id="7893346178-102">}</span><span class="p" data-group-id="7893346178-101">}</span><span class="p" data-group-id="7893346178-100">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-98">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">encode_handoff_item</span><span class="p" data-group-id="7893346178-103">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-103">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-104">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-105">(</span><span class="s">&quot;Encode handoff item: </span><span class="si" data-group-id="7893346178-106">#{</span><span class="n">k</span><span class="si" data-group-id="7893346178-106">}</span><span class="s"> </span><span class="si" data-group-id="7893346178-107">#{</span><span class="n">v</span><span class="si" data-group-id="7893346178-107">}</span><span class="s">&quot;</span><span class="p" data-group-id="7893346178-105">)</span><span class="w">
      </span><span class="nc">:erlang</span><span class="o">.</span><span class="n">term_to_binary</span><span class="p" data-group-id="7893346178-108">(</span><span class="p" data-group-id="7893346178-109">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-109">}</span><span class="p" data-group-id="7893346178-108">)</span><span class="w">
  </span><span class="k" data-group-id="7893346178-104">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_handoff_data</span><span class="p" data-group-id="7893346178-110">(</span><span class="n">bin_data</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-110">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-111">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-112">(</span><span class="s">&quot;Handle handoff data - bin_data: </span><span class="si" data-group-id="7893346178-113">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-114">(</span><span class="n">bin_data</span><span class="p" data-group-id="7893346178-114">)</span><span class="si" data-group-id="7893346178-113">}</span><span class="s"> - </span><span class="si" data-group-id="7893346178-115">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-116">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-116">)</span><span class="si" data-group-id="7893346178-115">}</span><span class="s">&quot;</span><span class="p" data-group-id="7893346178-112">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-117">{</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-117">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">:erlang</span><span class="o">.</span><span class="n">binary_to_term</span><span class="p" data-group-id="7893346178-118">(</span><span class="n">bin_data</span><span class="p" data-group-id="7893346178-118">)</span><span class="w">
      </span><span class="n">new_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">update</span><span class="p" data-group-id="7893346178-119">(</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="ss">:data</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-120">%{</span><span class="p" data-group-id="7893346178-120">}</span><span class="p">,</span><span class="w"> </span><span class="k" data-group-id="7893346178-121">fn</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p" data-group-id="7893346178-122">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p" data-group-id="7893346178-122">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-121">end</span><span class="p" data-group-id="7893346178-119">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-123">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">new_state</span><span class="p" data-group-id="7893346178-123">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-111">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_coverage</span><span class="p" data-group-id="7893346178-124">(</span><span class="ss">:keys</span><span class="p">,</span><span class="w"> </span><span class="c">_key_spaces</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-125">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7893346178-125">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-126">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="7893346178-126">}</span><span class="p" data-group-id="7893346178-124">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-127">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-128">(</span><span class="s">&quot;Received keys coverage: </span><span class="si" data-group-id="7893346178-129">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-130">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-130">)</span><span class="si" data-group-id="7893346178-129">}</span><span class="s">&quot;</span><span class="p" data-group-id="7893346178-128">)</span><span class="w">
      </span><span class="n">keys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">keys</span><span class="p" data-group-id="7893346178-131">(</span><span class="n">data</span><span class="p" data-group-id="7893346178-131">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-132">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-133">{</span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="n">keys</span><span class="p" data-group-id="7893346178-133">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-132">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-127">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_coverage</span><span class="p" data-group-id="7893346178-134">(</span><span class="ss">:values</span><span class="p">,</span><span class="w"> </span><span class="c">_key_spaces</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-135">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7893346178-135">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-136">%{</span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="n">data</span><span class="p" data-group-id="7893346178-136">}</span><span class="p" data-group-id="7893346178-134">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-137">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-138">(</span><span class="s">&quot;Received values coverage: </span><span class="si" data-group-id="7893346178-139">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-140">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-140">)</span><span class="si" data-group-id="7893346178-139">}</span><span class="s">&quot;</span><span class="p" data-group-id="7893346178-138">)</span><span class="w">
      </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nc">Map</span><span class="o">.</span><span class="n">values</span><span class="p" data-group-id="7893346178-141">(</span><span class="n">data</span><span class="p" data-group-id="7893346178-141">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-142">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-143">{</span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p" data-group-id="7893346178-143">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-142">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-137">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_coverage</span><span class="p" data-group-id="7893346178-144">(</span><span class="ss">:clear</span><span class="p">,</span><span class="w"> </span><span class="c">_key_spaces</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-145">{</span><span class="bp">_</span><span class="p">,</span><span class="w"> </span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="bp">_</span><span class="p" data-group-id="7893346178-145">}</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-144">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-146">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span><span class="p" data-group-id="7893346178-147">(</span><span class="s">&quot;Received clear coverage: </span><span class="si" data-group-id="7893346178-148">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-149">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-149">)</span><span class="si" data-group-id="7893346178-148">}</span><span class="s"> &quot;</span><span class="p" data-group-id="7893346178-147">)</span><span class="w">
      </span><span class="n">new_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p" data-group-id="7893346178-150">%{</span><span class="n">state</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="ss">data</span><span class="p">:</span><span class="w"> </span><span class="p" data-group-id="7893346178-151">%{</span><span class="p" data-group-id="7893346178-151">}</span><span class="p" data-group-id="7893346178-150">}</span><span class="w">
      </span><span class="p" data-group-id="7893346178-152">{</span><span class="ss">:reply</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-153">{</span><span class="n">req_id</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="7893346178-154">[</span><span class="p" data-group-id="7893346178-154">]</span><span class="p" data-group-id="7893346178-153">}</span><span class="p">,</span><span class="w"> </span><span class="n">new_state</span><span class="p" data-group-id="7893346178-152">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-146">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handle_exit</span><span class="p" data-group-id="7893346178-155">(</span><span class="n">pid</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-155">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-156">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">error</span><span class="p" data-group-id="7893346178-157">(</span><span class="w">
      </span><span class="s">&quot;Handling exit: self: </span><span class="si" data-group-id="7893346178-158">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-159">(</span><span class="n">self</span><span class="p" data-group-id="7893346178-160">(</span><span class="p" data-group-id="7893346178-160">)</span><span class="p" data-group-id="7893346178-159">)</span><span class="si" data-group-id="7893346178-158">}</span><span class="s"> - pid: </span><span class="si" data-group-id="7893346178-161">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-162">(</span><span class="n">pid</span><span class="p" data-group-id="7893346178-162">)</span><span class="si" data-group-id="7893346178-161">}</span><span class="s"> - reason: </span><span class="si" data-group-id="7893346178-163">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-164">(</span><span class="n">reason</span><span class="p" data-group-id="7893346178-164">)</span><span class="si" data-group-id="7893346178-163">}</span><span class="s"> - state: </span><span class="si" data-group-id="7893346178-165">#{</span><span class="n">inspect</span><span class="p" data-group-id="7893346178-166">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-166">)</span><span class="si" data-group-id="7893346178-165">}</span><span class="s">&quot;</span><span class="w">
      </span><span class="p" data-group-id="7893346178-157">)</span><span class="w">

      </span><span class="p" data-group-id="7893346178-167">{</span><span class="ss">:noreply</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-167">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-156">end</span><span class="w">

  </span><span class="kd">def</span><span class="w"> </span><span class="nf">handoff_cancelled</span><span class="p" data-group-id="7893346178-168">(</span><span class="n">state</span><span class="p" data-group-id="7893346178-168">)</span><span class="w"> </span><span class="k" data-group-id="7893346178-169">do</span><span class="w">
      </span><span class="nc">Logger</span><span class="o">.</span><span class="n">error</span><span class="p" data-group-id="7893346178-170">(</span><span class="s">&quot;Handoff cancelled with state: </span><span class="si" data-group-id="7893346178-171">#{</span><span class="n">state</span><span class="si" data-group-id="7893346178-171">}</span><span class="s">&quot;</span><span class="p" data-group-id="7893346178-170">)</span><span class="w">
      </span><span class="p" data-group-id="7893346178-172">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="p" data-group-id="7893346178-172">}</span><span class="w">
  </span><span class="k" data-group-id="7893346178-169">end</span><span class="w">
</span><span class="k" data-group-id="7893346178-1">end</span></code></pre><p>If our setup is working, we can call it using the Riax module</p><p>Example:</p><pre><code class="makeup elixir" translate="no"><span class="w">  </span><span class="n">iex</span><span class="p" data-group-id="4260479046-1">(</span><span class="n">dev1</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p" data-group-id="4260479046-1">)</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Riax</span><span class="o">.</span><span class="n">sync_command</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4260479046-2">{</span><span class="ss">:ping</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p" data-group-id="4260479046-2">}</span><span class="w">
      </span><span class="mi">17</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mf">35.559</span><span class="w"> </span><span class="p" data-group-id="4260479046-3">[</span><span class="n">debug</span><span class="p" data-group-id="4260479046-3">]</span><span class="w"> </span><span class="nc">Received</span><span class="w"> </span><span class="n">ping</span><span class="w"> </span><span class="n">command!</span><span class="w">
      </span><span class="p" data-group-id="4260479046-4">{</span><span class="ss">:pong</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="ss">:&quot;dev1@127.0.0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">822094670998632891489572718402909198556462055424</span><span class="p" data-group-id="4260479046-4">}</span><span class="w">
  </span><span class="n">iex</span><span class="p" data-group-id="4260479046-5">(</span><span class="n">dev1</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p" data-group-id="4260479046-5">)</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Riax</span><span class="o">.</span><span class="n">sync_command</span><span class="p" data-group-id="4260479046-6">(</span><span class="ss">:some_identifier</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4260479046-7">{</span><span class="ss">:put</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4260479046-8">{</span><span class="ss">:my_key</span><span class="p">,</span><span class="w"> </span><span class="ss">:my_value</span><span class="p" data-group-id="4260479046-8">}</span><span class="p" data-group-id="4260479046-7">}</span><span class="p" data-group-id="4260479046-6">)</span><span class="w">
      </span><span class="mi">17</span><span class="p">:</span><span class="mi">09</span><span class="p">:</span><span class="mf">57.727</span><span class="w"> </span><span class="p" data-group-id="4260479046-9">[</span><span class="n">debug</span><span class="p" data-group-id="4260479046-9">]</span><span class="w"> </span><span class="nc">PUT</span><span class="w"> </span><span class="ss">Key</span><span class="p">:</span><span class="w"> </span><span class="ss">:my_key</span><span class="p">,</span><span class="w"> </span><span class="ss">Value</span><span class="p">:</span><span class="w"> </span><span class="ss">:my_value</span><span class="w">
      </span><span class="ss">:ok</span><span class="w">
  </span><span class="n">iex</span><span class="p" data-group-id="4260479046-10">(</span><span class="n">dev1</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p" data-group-id="4260479046-10">)</span><span class="mi">3</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Riax</span><span class="o">.</span><span class="n">sync_command</span><span class="p" data-group-id="4260479046-11">(</span><span class="ss">:some_identifier</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4260479046-12">{</span><span class="ss">:get</span><span class="p">,</span><span class="w"> </span><span class="ss">:my_key</span><span class="p" data-group-id="4260479046-12">}</span><span class="p" data-group-id="4260479046-11">)</span><span class="w">
      </span><span class="mi">17</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mf">11.336</span><span class="w"> </span><span class="p" data-group-id="4260479046-13">[</span><span class="n">debug</span><span class="p" data-group-id="4260479046-13">]</span><span class="w"> </span><span class="nc">GET</span><span class="w"> </span><span class="n">my_key</span><span class="w">
      </span><span class="ss">:my_value</span><span class="w">
  </span><span class="n">iex</span><span class="p" data-group-id="4260479046-14">(</span><span class="n">dev1</span><span class="err">@</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p" data-group-id="4260479046-14">)</span><span class="mi">4</span><span class="o">&gt;</span><span class="w"> </span><span class="nc">Riax</span><span class="o">.</span><span class="n">preferred_node</span><span class="p" data-group-id="4260479046-15">(</span><span class="ss">:some_identifier</span><span class="p" data-group-id="4260479046-15">)</span><span class="w">
      </span><span class="p" data-group-id="4260479046-16">{</span><span class="ss">:ok</span><span class="p">,</span><span class="w"> </span><span class="p" data-group-id="4260479046-17">{</span><span class="mi">639406966332270026714112114313373821099470487552</span><span class="p">,</span><span class="w"> </span><span class="ss">:&quot;dev1@127.0.0.1&quot;</span><span class="p" data-group-id="4260479046-17">}</span><span class="p" data-group-id="4260479046-16">}</span></code></pre><p> This tells us the key <code class="inline">:my_key</code> and value <code class="inline">:my_value</code> pair
 ended up in the Virtual Node <code class="inline">:&quot;dev1@127.0.0.1&quot;</code></p><h1>Handoff :</h1><p>  Ownership of a partition (that is, key distribution between nodes) may be
  transferred from one virtual node to another in a different node when nodes
  join (via <a href="Riax.html#join/1"><code class="inline">Riax.join/1</code></a>) or are removed from the cluster, and under certain
  failure scenarios to guarantee high availability. If a node goes down
  unexpectedly, the partitions owned by the virtual nodes it contained will be
  temporarily handled by virtual nodes in other physical nodes. If the
  original node comes back up, ownership will eventually be transferred back
  to the original owners, also called primary virtual nodes. The virtual nodes
  that took over ownership in that scenario are called secondary virtual
  nodes. The process by which this ownership is negotiated and any relevant
  data is transferred to accomplish that is what we call a handoff. Transfer
  of ownership may also occur when adding or removing physical nodes to the
  cluster.</p><h1>Handoff process:</h1><p>  First of all, keep in mind that when the handoff is in progress,
  a VNode will handle its requests via <code class="inline">handle_handoff_command/3</code>,
  it can drop the request, forward it or handle it.
  When the handoff starts it works like this:</p><ol><li><p>The callback <code class="inline">handoff_starting/2</code> is called. If it returns a <code class="inline">{:false, state}</code> tuple, the handoff is cancelled. Else, it calls <code class="inline">is_empty/1</code> to
check if the VNode has something to hand off.</p></li><li><p>If <code class="inline">is_empty/1</code> it returns a <code class="inline">:false</code> tuple, the handoff continues</p></li><li><p><code class="inline">handle_handoff_fold/3</code> is called with a folding function and an
accumulator as parameters. The provided accumulator works just fine with
the Enum module. The given fold_function turns the VNode's state into
key-value pairs (see the example) and, before sending them to its
corresponding Virtual Node, calls encode_handoff_item/2 to encode them.</p></li><li><p>Said encoding will be then decoded by <code class="inline">handle_handoff_data/2</code> in the receiving
Virtual Node. When all the key-values are sent, <code class="inline">handoff_finished/2</code> is called.</p></li></ol>
  </section>


  <section id="summary" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#summary">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
      Summary
    </h1>

  <div class="summary-types summary">
    <h2>
      <a href="#types">Types</a>
    </h2>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#t:handoff_dest/0" translate="no">handoff_dest()</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#t:keyspaces/0" translate="no">keyspaces()</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#t:partition/0" translate="no">partition()</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#t:sender/0" translate="no">sender()</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#t:sender_type/0" translate="no">sender_type()</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#t:vnode_req/0" translate="no">vnode_req()</a>

        </div>

      </div>

  </div>

  <div class="summary-callbacks summary">
    <h2>
      <a href="#callbacks">Callbacks</a>
    </h2>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:delete/1" translate="no">delete(state)</a>

        </div>

          <div class="summary-synopsis"><p>Called when the VNode data is to be deleted.
Can be used for a preemptive cleanup of the VNode.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:encode_handoff_item/2" translate="no">encode_handoff_item(key, value)</a>

        </div>

          <div class="summary-synopsis"><p>This function is called before sending data to another running VNode during a
handoff. The key-value pairs returned by the fold_function given to
<code class="inline">handle_handoff_fold/4</code> will be encoded by this function.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handle_command/3" translate="no">handle_command(request, sender, state)</a>

        </div>

          <div class="summary-synopsis"><p>Responsible of answering commands
sent with either <a href="Riax.html#sync_command/3"><code class="inline">Riax.sync_command/3</code></a>, <a href="Riax.html#async_command/3"><code class="inline">Riax.async_command/3</code></a> or
<a href="Riax.html#cast_command/3"><code class="inline">Riax.cast_command/3</code></a>.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handle_coverage/4" translate="no">handle_coverage(request, keyspaces, sender, state)</a>

        </div>

          <div class="summary-synopsis"><p>Handles a command given by the <a href="Riax.html#coverage_command/2"><code class="inline">Riax.coverage_command/2</code></a> function.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handle_exit/3" translate="no">handle_exit(pid, reason, state)</a>

        </div>

          <div class="summary-synopsis"><p>Callback called in the case that a process linked to the VNode process dies
and allows the module using the behaviour to take appropiate action.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handle_handoff_command/3" translate="no">handle_handoff_command(
  request,
  sender,
  state
)</a>

        </div>

          <div class="summary-synopsis"><p>Like <code class="inline">handle_handoff_command/3</code> but this function takes care of handling
requests during a handoff.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handle_handoff_data/2" translate="no">handle_handoff_data(binary, state)</a>

        </div>

          <div class="summary-synopsis"><p>When a handoff is in progress, data is received by the new vnode and must
decode it and do something with it, this is done by this callback.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handle_handoff_fold/4" translate="no">handle_handoff_fold(
  fold_function,
  acc,
  sender,
  state
)</a>

        </div>

          <div class="summary-synopsis"><p>This function has the job of converting the VNode state into a key-value pair.
These key-value pairs will be then encoded by the <code class="inline">encode_handoff_item/2</code>
callback.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handoff_cancelled/1" translate="no">handoff_cancelled(state)</a>

        </div>

          <div class="summary-synopsis"><p>This function is called when a handoff process affecting this vnode process
gets cancelled. It can be used to undo changes made in handoff_starting/2.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handoff_finished/2" translate="no">handoff_finished(handoff_dest, state)</a>

        </div>

          <div class="summary-synopsis"><p>Called when a handoff finishes.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:handoff_starting/2" translate="no">handoff_starting(handoff_dest, state)</a>

        </div>

          <div class="summary-synopsis"><p>Callback that is called when a handoff starts.
See the Handoff Process section.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:init/1" translate="no">init(list)</a>

        </div>

          <div class="summary-synopsis"><p>Set up VNode state and data structure. It recieves a list
its assigned partition and should return the VNode's initial state.</p></div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#c:is_empty/1" translate="no">is_empty(state)</a>

        </div>

          <div class="summary-synopsis"><p>This callback is used to determine if the
VNode's state data structure is empty.</p></div>

      </div>

  </div>

  <div class="summary-functions summary">
    <h2>
      <a href="#functions">Functions</a>
    </h2>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#fold_req_v1/1" translate="no">fold_req_v1(args \\ [])</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#fold_req_v1/2" translate="no">fold_req_v1(record, args)</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#fold_req_v2/1" translate="no">fold_req_v2(args \\ [])</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#fold_req_v2/2" translate="no">fold_req_v2(record, args)</a>

        </div>

      </div>

      <div class="summary-row">
        <div class="summary-signature">
          <a href="#start_vnode/1" translate="no">start_vnode(partition)</a>

        </div>

      </div>

  </div>

  </section>


  <section id="types" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#types">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
Types
    </h1>
    <div class="types-list">
<section class="detail" id="t:handoff_dest/0">

  <div class="detail-header">
    <a href="#t:handoff_dest/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">handoff_dest()</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> handoff_dest() :: {<a href="https://hexdocs.pm/riak_core/riak_kv-3.0.9+build.2069.refb56593a/riak_core_handoff_manager.html#t:ho_type/0">:riak_core_handoff_manager.ho_type</a>(), {<a href="#t:partition/0">partition</a>(), <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">node</a>()}}</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:keyspaces/0">

  <div class="detail-header">
    <a href="#t:keyspaces/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">keyspaces()</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> keyspaces() :: [{<a href="#t:partition/0">partition</a>(), [<a href="#t:partition/0">partition</a>()]}]</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:partition/0">

  <div class="detail-header">
    <a href="#t:partition/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">partition()</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> partition() :: <a href="https://hexdocs.pm/riak_core/riak_kv-3.0.9+build.2069.refb56593a/chash.html#t:index_as_int/0">:chash.index_as_int</a>()</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:sender/0">

  <div class="detail-header">
    <a href="#t:sender/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">sender()</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> sender() ::
  {<a href="#t:sender_type/0">sender_type</a>(), <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">reference</a>() | <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">tuple</a>(), <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pid</a>()}
  | {:server, :undefined, :undefined}
  | {:fsm, :undefined, <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pid</a>()}
  | :ignore</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:sender_type/0">

  <div class="detail-header">
    <a href="#t:sender_type/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">sender_type()</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> sender_type() :: :fsm | :server | :raw</pre>

      </div>


  </section>
</section>
<section class="detail" id="t:vnode_req/0">

  <div class="detail-header">
    <a href="#t:vnode_req/0" class="detail-link" title="Link to this type">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this type</span>
    </a>
    <h1 class="signature" translate="no">vnode_req()</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@type</span> vnode_req() :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()</pre>

      </div>


  </section>
</section>

    </div>
  </section>

  <section id="callbacks" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#callbacks">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
Callbacks
    </h1>
    <div class="callbacks-list">
<section class="detail" id="c:delete/1">

  <div class="detail-header">
    <a href="#c:delete/1" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">delete(state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> delete(state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) :: {:ok, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>Called when the VNode data is to be deleted.
Can be used for a preemptive cleanup of the VNode.</p>
  </section>
</section>
<section class="detail" id="c:encode_handoff_item/2">

  <div class="detail-header">
    <a href="#c:encode_handoff_item/2" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">encode_handoff_item(key, value)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> encode_handoff_item(key :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), value :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) :: {:ok, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>This function is called before sending data to another running VNode during a
handoff. The key-value pairs returned by the fold_function given to
<code class="inline">handle_handoff_fold/4</code> will be encoded by this function.</p>
  </section>
</section>
<section class="detail" id="c:handle_command/3">

  <div class="detail-header">
    <a href="#c:handle_command/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_command(request, sender, state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handle_command(request :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), sender :: <a href="#t:sender/0">sender</a>(), state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) ::
  :continue
  | {:reply, reply :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>(), new_mod_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}
  | {:noreply, new_mode_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}
  | {:async, work :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">function</a>(), from :: <a href="#t:sender/0">sender</a>(), new_mod_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}
  | {:stop, reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>(), new_mod_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}</pre>

      </div>

<p>Responsible of answering commands
sent with either <a href="Riax.html#sync_command/3"><code class="inline">Riax.sync_command/3</code></a>, <a href="Riax.html#async_command/3"><code class="inline">Riax.async_command/3</code></a> or
<a href="Riax.html#cast_command/3"><code class="inline">Riax.cast_command/3</code></a>.</p><h1>Parameters:</h1><ul><li>request: The command to be handled.</li><li>sender: The process sending the request.</li><li>state: The VNode's current state.
Keep in mind that sender is :ignored when using <a href="Riax.html#cast_command/3"><code class="inline">Riax.cast_command/3</code></a>.</li></ul>
  </section>
</section>
<section class="detail" id="c:handle_coverage/4">

  <div class="detail-header">
    <a href="#c:handle_coverage/4" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_coverage(request, keyspaces, sender, state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handle_coverage(
  request :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(),
  <a href="#t:keyspaces/0">keyspaces</a>(),
  sender :: <a href="#t:sender/0">sender</a>(),
  state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()
) ::
  :continue
  | {:reply, reply :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:noreply, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:async, work :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">function</a>(), from :: <a href="#t:sender/0">sender</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:stop, reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>Handles a command given by the <a href="Riax.html#coverage_command/2"><code class="inline">Riax.coverage_command/2</code></a> function.</p>
  </section>
</section>
<section class="detail" id="c:handle_exit/3">

  <div class="detail-header">
    <a href="#c:handle_exit/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_exit(pid, reason, state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handle_exit(<a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pid</a>(), reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) ::
  {:noreply, new_mod_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:stop, reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>Callback called in the case that a process linked to the VNode process dies
and allows the module using the behaviour to take appropiate action.</p>
  </section>
</section>
<section class="detail" id="c:handle_handoff_command/3">

  <div class="detail-header">
    <a href="#c:handle_handoff_command/3" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_handoff_command(
  request,
  sender,
  state
)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handle_handoff_command(
  request :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(),
  sender :: <a href="#t:sender/0">sender</a>(),
  state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()
) ::
  {:reply, reply :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:noreply, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:forward, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:drop, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:stop, reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>Like <code class="inline">handle_handoff_command/3</code> but this function takes care of handling
requests during a handoff.</p><h1>Return</h1><p>This callback can also eturn a tuple that has as
its first element :<code class="inline">reply,</code> <code class="inline">:noreply</code>, :<code class="inline">forward</code>, <code class="inline">:drop</code> or <code class="inline">:stop</code> tuple.
If the function returns <code class="inline">:foward</code> it forwards the request to another VNode,
<code class="inline">:drop</code> drops the request. Useful if, for example, you don't want to handle
requests during a handoff.</p>
  </section>
</section>
<section class="detail" id="c:handle_handoff_data/2">

  <div class="detail-header">
    <a href="#c:handle_handoff_data/2" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_handoff_data(binary, state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handle_handoff_data(<a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">binary</a>(), state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) ::
  {:reply, :ok | {:error, reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}, state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>When a handoff is in progress, data is received by the new vnode and must
decode it and do something with it, this is done by this callback.</p>
  </section>
</section>
<section class="detail" id="c:handle_handoff_fold/4">

  <div class="detail-header">
    <a href="#c:handle_handoff_fold/4" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handle_handoff_fold(
  fold_function,
  acc,
  sender,
  state
)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handle_handoff_fold(
  fold_function :: (... -&gt; <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()),
  acc :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(),
  sender :: <a href="#t:sender/0">sender</a>(),
  state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()
) ::
  {:reply, reply :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:noreply, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:forward, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:drop, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}
  | {:stop, reason :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>This function has the job of converting the VNode state into a key-value pair.
These key-value pairs will be then encoded by the <code class="inline">encode_handoff_item/2</code>
callback.</p><h2 id="c:handle_handoff_fold/4-parameters" class="section-heading">
  <a href="#c:handle_handoff_fold/4-parameters" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">parameters</p>
  </a>
  Parameters:
</h2>
<ul><li><p>fold_function: Function that reduces/folds the VNode's actual state into key-value pairs.</p></li><li><p>acc: The initial accumulator for the fold_function.</p></li><li><p>sender: The process sending the handoff request.</p></li><li><p>state: VNode state.</p></li></ul><h2 id="c:handle_handoff_fold/4-return" class="section-heading">
  <a href="#c:handle_handoff_fold/4-return" class="hover-link"><i class="ri-link-m" aria-hidden="true"></i>
  <p class="sr-only">return</p>
  </a>
  Return:
</h2>
<p>The return values work just like in handle_handoff_command/3.</p>
  </section>
</section>
<section class="detail" id="c:handoff_cancelled/1">

  <div class="detail-header">
    <a href="#c:handoff_cancelled/1" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handoff_cancelled(state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handoff_cancelled(state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) :: {:ok, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>This function is called when a handoff process affecting this vnode process
gets cancelled. It can be used to undo changes made in handoff_starting/2.</p>
  </section>
</section>
<section class="detail" id="c:handoff_finished/2">

  <div class="detail-header">
    <a href="#c:handoff_finished/2" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handoff_finished(handoff_dest, state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handoff_finished(<a href="#t:handoff_dest/0">handoff_dest</a>(), state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) :: {:ok, new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}</pre>

      </div>

<p>Called when a handoff finishes.</p>
  </section>
</section>
<section class="detail" id="c:handoff_starting/2">

  <div class="detail-header">
    <a href="#c:handoff_starting/2" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">handoff_starting(handoff_dest, state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> handoff_starting(<a href="#t:handoff_dest/0">handoff_dest</a>(), state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()) ::
  {<a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">boolean</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>Callback that is called when a handoff starts.
See the Handoff Process section.</p>
  </section>
</section>
<section class="detail" id="c:init/1">

  <div class="detail-header">
    <a href="#c:init/1" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">init(list)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> init([<a href="#t:partition/0">partition</a>()]) :: {:ok, initial_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>Set up VNode state and data structure. It recieves a list
its assigned partition and should return the VNode's initial state.</p>
  </section>
</section>
<section class="detail" id="c:is_empty/1">

  <div class="detail-header">
    <a href="#c:is_empty/1" class="detail-link" title="Link to this callback">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this callback</span>
    </a>
    <h1 class="signature" translate="no">is_empty(state)</h1>


  </div>

  <section class="docstring">

      <div class="specs">

          <pre translate="no"><span class="attribute">@callback</span> is_empty(state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()) ::
  {<a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">boolean</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#built-in-types">term</a>()}
  | {false, size :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">pos_integer</a>(), new_state :: <a href="https://hexdocs.pm/elixir/typespecs.html#basic-types">any</a>()}</pre>

      </div>

<p>This callback is used to determine if the
VNode's state data structure is empty.</p>
  </section>
</section>

    </div>
  </section>

  <section id="functions" class="details-list">
    <h1 class="section-heading">
      <a class="hover-link" href="#functions">
        <i class="ri-link-m" aria-hidden="true"></i>
        <span class="sr-only">Link to this section</span>
      </a>
Functions
    </h1>
    <div class="functions-list">
<section class="detail" id="fold_req_v1/1">

    <span id="fold_req_v1/0"></span>

  <div class="detail-header">
    <a href="#fold_req_v1/1" class="detail-link" title="Link to this macro">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this macro</span>
    </a>
    <h1 class="signature" translate="no">fold_req_v1(args \\ [])</h1>


      <span class="note">(macro)</span>

  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="fold_req_v1/2">

  <div class="detail-header">
    <a href="#fold_req_v1/2" class="detail-link" title="Link to this macro">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this macro</span>
    </a>
    <h1 class="signature" translate="no">fold_req_v1(record, args)</h1>


      <span class="note">(macro)</span>

  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="fold_req_v2/1">

    <span id="fold_req_v2/0"></span>

  <div class="detail-header">
    <a href="#fold_req_v2/1" class="detail-link" title="Link to this macro">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this macro</span>
    </a>
    <h1 class="signature" translate="no">fold_req_v2(args \\ [])</h1>


      <span class="note">(macro)</span>

  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="fold_req_v2/2">

  <div class="detail-header">
    <a href="#fold_req_v2/2" class="detail-link" title="Link to this macro">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this macro</span>
    </a>
    <h1 class="signature" translate="no">fold_req_v2(record, args)</h1>


      <span class="note">(macro)</span>

  </div>

  <section class="docstring">


  </section>
</section>
<section class="detail" id="start_vnode/1">

  <div class="detail-header">
    <a href="#start_vnode/1" class="detail-link" title="Link to this function">
      <i class="ri-link-m" aria-hidden="true"></i>
      <span class="sr-only">Link to this function</span>
    </a>
    <h1 class="signature" translate="no">start_vnode(partition)</h1>


  </div>

  <section class="docstring">


  </section>
</section>

    </div>
  </section>

      <footer class="footer">

        <p>
          Built using
          <a href="https://github.com/elixir-lang/ex_doc" title="ExDoc" target="_blank" rel="help noopener" translate="no">ExDoc</a> (v0.28.4) for the

            <a href="https://elixir-lang.org" title="Elixir" target="_blank" translate="no">Elixir programming language</a>

        </p>
      </footer>
    </div>
  </div>
</section>
</div>


  </body>
</html>
